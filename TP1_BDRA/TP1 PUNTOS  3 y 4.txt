-- PUNTO 3)

CREATE TABLE Pedidos (
	Nro_Orden INT UNIQUE NOT NULL,
	Fecha_Orden DATETIME DEFAULT GETDATE(),
	CUIT_Cliente CHAR(11) NOT NULL,
	CUIT_Proveedor CHAR(11),
	Nro_Producto INT,
	Tipo_Pedido CHAR(1) CHECK (Tipo_Pedido IN ('M', 'C', 'G', 'H', 'N')),
	Cantidad_Pedida INT CHECK (Cantidad_Pedida > 0),
	CONSTRAINT PK_Pedidos PRIMARY KEY (Nro_Orden, CUIT_Cliente),
	CONSTRAINT FK_Cliente FOREIGN KEY (CUIT_Cliente) REFERENCES Clientes (Cuit)
);

CREATE TRIGGER Control_pedido
ON Pedidos
INSTEAD OF INSERT 
AS
BEGIN
    SET NOCOUNT ON;

    IF EXISTS (
        SELECT 1
        FROM INSERTED i
        JOIN Stock_productos s ON i.Nro_Producto = s.nro_producto
        WHERE i.Cantidad_Pedida > s.stock_actual
    )
    BEGIN
        THROW 50001, 'La cantidad pedida supera el stock disponible', 1;
        RETURN;
    END

    UPDATE s
    SET s.stock_actual = s.stock_actual - i.Cantidad_Pedida
    FROM Stock_productos s
    INNER JOIN INSERTED i ON s.nro_producto = i.Nro_Producto;

    INSERT INTO Pedidos (
        Nro_Orden,
        CUIT_Cliente,
        CUIT_Proveedor,
        Nro_Producto,
        Tipo_Pedido,
        Cantidad_Pedida
    )
    SELECT
        i.Nro_Orden,
        i.CUIT_Cliente,
        i.CUIT_Proveedor,
        i.Nro_Producto,
        i.Tipo_Pedido,
        i.Cantidad_Pedida
    FROM INSERTED i;
END;

-- PUNTO 4)

ALTER TABLE Pedidos ADD CONSTRAINT ClaveProducto FOREIGN KEY (Nro_Producto, Tipo_Pedido) REFERENCES Productos (nro_producto, tipo_pedido);

ALTER TABLE Pedidos ADD CONSTRAINT CantidadPermitida CHECK (Cantidad_Pedida BETWEEN 10 AND 2000);

ALTER TABLE Pedidos WITH NOCHECK ADD CONSTRAINT ControlCUIT CHECK (CUIT_Cliente <> CUIT_Proveedor);

ALTER TABLE Stock_productos ADD CONSTRAINT ControlStock CHECK (stock_actual >= stock_minimo);

